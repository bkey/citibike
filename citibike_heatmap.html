<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Current CitiBike Heatmap</title>
    <style>
      body, html { margin:0; padding:0; height:100%;}
      body { font-family:sans-serif; }
      body * { font-weight:200;}
      h1 { position:absolute; background:white; padding:10px;}
      #map { height:100%; }
      .leaflet-container {
        background: rgba(0,0,0,.8) !important;
      }
    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script type="text/javascript" src="shCore.js"></script>
	<script type="text/javascript" src="shBrushJScript.js"></script>
	<script type="text/javascript" src="webgl-heatmap.js"></script>
	<script type="text/javascript" src="webgl-heatmap-leaflet.js"></script>
  </head>

    <script type="text/javascript" charset="utf-8">
    
	  var availBikesLayer;
	  var availDocksLayer;
	  var totalDocksLayer;
	  var stationPops;
	  
	  var stations = []
	
      function init() {
      
        var baseLayer = L.tileLayer(
          'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
            maxZoom: 18
          }
        );

        availBikesLayer = new L.TileLayer.WebGLHeatMap({size: 1100, autoresize: true, opacity: .5}); 
        availDocksLayer = new L.TileLayer.WebGLHeatMap({size: 800, autoresize: true, opacity: .5});
        totalDocksLayer = new L.TileLayer.WebGLHeatMap({size: 800, autoresize: true, opacity: .5});


        map = new L.Map('map', {
			center: new L.LatLng(40.7361, -73.9901),
			zoom: 13,
			layers: [baseLayer]
		});

        getdata();
        
        stationPops = new L.LayerGroup();
        
		var baseMaps = {
   			"Available Bikes": availBikesLayer,
    		"Available Docks": availDocksLayer,
    		"Total Docks": totalDocksLayer
		}
		
		var overlayMaps = {
    		"Stations": stationPops
		};
		
		L.control.layers(baseMaps,overlayMaps,{collapsed: false}).addTo(map);
		
      };
      
    function getdata()
	{				
		
		$.ajax({
  			type: 'GET',
  			url: 'get_citibike.php',
  			contentType: 'application/json; charset=utf-8',
  			dataType: 'json',
  			complete: function (jsonData)  {
  				
    			var obj = JSON.parse(jsonData.responseText);
    			
    			var beanList = obj.stationBeanList;
    			for (var i in beanList) {
    				var s_lat = beanList[i].latitude;
    				var s_lon = beanList[i].longitude;
    				availBikesLayer.addDataPoint(s_lat, s_lon, beanList[i].availableBikes);
    				availDocksLayer.addDataPoint(s_lat, s_lon, beanList[i].availableDocks);
    				totalDocksLayer.addDataPoint(s_lat, s_lon, beanList[i].totalDocks);
    				
    				L.circle([s_lat, s_lon], 3,{
    					color: 'black'}).bindPopup('<strong>' + beanList[i].stationName + '</strong><BR />' +
    														  'Available Bikes: ' + beanList[i].availableBikes + '<BR />' +
    														  'Available Docks: ' + beanList[i].availableDocks + '<BR />' +
    														  'Total Docks: ' + beanList[i].totalDocks).addTo(stationPops);
    				
    				}	
    				
    			return stations;
    			
  			},
  			error: function() {
    			alert('Error Loading CitiBike JSON File');
  			}
		});
	}
		
	</script>
	
	<body onload="init()">
		<div id="map"></div>
	</body>
</html>